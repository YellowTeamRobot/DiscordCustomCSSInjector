<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord CustomCSS Preload Injector</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
            background-color: #f8f9fa;
        }
        h1 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 20px;
        }
        details {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: inline-block;
			max-width: 100%;
        }
        summary {
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
			padding-left: 43ch;
			padding-right: 43ch;
        }
        p {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        input[type="file"] {
            padding: 10px;
            margin: 20px 0;
            font-size: 1rem;
            cursor: pointer;
        }
        button {
            background-color: #007bff;
            color: #fff;
            padding: 12px 24px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .footer {
            margin-top: 30px;
            font-size: 0.9rem;
            color: #777;
        }
		.highlight {
			background-color: #E2EAF4; 
			cursor: pointer; 
		}
    </style>
</head>
<body>
    <h1>Discord CustomCSS Preload Injector</h1>

    <details>
        <summary>Instructions/Info</summary>
		<p><em>Make sure to back up your core.asar before trying the new one!</em></p>
        <p>core.asar can be found in:</p>
        <p>&nbsp; - <strong>Windows:</strong> "%LocalAppData%/Discord/app-&ltCURRENT_VERSION&gt/modules/discord_desktop_core-1/discord_desktop_core/"</p>
        <p>&nbsp; - <strong>Linux:</strong> "HOME_DIRECTORY/.var/app/com.discordapp.Discord/config/discord/&ltCURRENT_VERSION&gt/modules/discord_desktop_core"</p>
        <p>If the patch is successful, replace core.asar with the new file (make sure to rename it from core_patched.asar to core.asar).</p>
		<p>Make sure to have a folder/file "%appdata%/discordcss/custom.css" on windows or "<span class="highlight" title="$XDG_CONFIG_HOME">~./config</span>/discordcss/custom.css" on linux</p>
    </details> <br>

    <input type="file" id="fileInput">
    <button id="patchButton">Patch & Download</button>

    <div class="footer">
        <p>Note: This tool is intended for advanced users, and replaces preload exception handling. Use at your own risk.</p>
    </div>

    <script>
	document.getElementById('patchButton').onclick = () => {
		const fileInput = document.getElementById('fileInput');
		if (!fileInput.files[0]) return alert("Please select a file first.");

		const reader = new FileReader();
		reader.onload = (e) => {
			let buffer = new Uint8Array(e.target.result);

			// Define the target and replacement as raw byte arrays
			const targetBytes =      new Uint8Array([0x70, 0x72, 0x6f, 0x63, 0x65, 0x73, 0x73, 0x2e, 0x6f, 0x6e, 0x28, 0x27, 0x75, 0x6e, 0x63, 0x61, 0x75, 0x67, 0x68, 0x74, 0x45, 0x78, 0x63, 0x65, 0x70, 0x74, 0x69, 0x6f, 0x6e, 0x27, 0x2c, 0x20, 0x28, 0x65, 0x72, 0x72, 0x2c, 0x20, 0x6f, 0x72, 0x69, 0x67, 0x69, 0x6e, 0x29, 0x20, 0x3d, 0x3e, 0x20, 0x7b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x76, 0x61, 0x72, 0x20, 0x5f, 0x75, 0x6e, 0x63, 0x61, 0x75, 0x67, 0x68, 0x74, 0x45, 0x78, 0x63, 0x65, 0x70, 0x74, 0x69, 0x6f, 0x6e, 0x48, 0x61, 0x6e, 0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x28, 0x5f, 0x75, 0x6e, 0x63, 0x61, 0x75, 0x67, 0x68, 0x74, 0x45, 0x78, 0x63, 0x65, 0x70, 0x74, 0x69, 0x6f, 0x6e, 0x48, 0x61, 0x6e, 0x20, 0x3d, 0x20, 0x75, 0x6e, 0x63, 0x61, 0x75, 0x67, 0x68, 0x74, 0x45, 0x78, 0x63, 0x65, 0x70, 0x74, 0x69, 0x6f, 0x6e, 0x48, 0x61, 0x6e, 0x64, 0x6c, 0x65, 0x72, 0x29, 0x20, 0x3d, 0x3d, 0x3d, 0x20, 0x6e, 0x75, 0x6c, 0x6c, 0x20, 0x7c, 0x7c, 0x20, 0x5f, 0x75, 0x6e, 0x63, 0x61, 0x75, 0x67, 0x68, 0x74, 0x45, 0x78, 0x63, 0x65, 0x70, 0x74, 0x69, 0x6f, 0x6e, 0x48, 0x61, 0x6e, 0x20, 0x3d, 0x3d, 0x3d, 0x20, 0x76, 0x6f, 0x69, 0x64, 0x20, 0x30, 0x20, 0x3f, 0x20, 0x76, 0x6f, 0x69, 0x64, 0x20, 0x30, 0x20, 0x3a, 0x20, 0x5f, 0x75, 0x6e, 0x63, 0x61, 0x75, 0x67, 0x68, 0x74, 0x45, 0x78, 0x63, 0x65, 0x70, 0x74, 0x69, 0x6f, 0x6e, 0x48, 0x61, 0x6e, 0x28, 0x65, 0x72, 0x72, 0x2c, 0x20, 0x6f, 0x72, 0x69, 0x67, 0x69, 0x6e, 0x29, 0x3b, 0x0a, 0x20, 0x20, 0x7d, 0x29, 0x3b]);

			const replacementBytes = new Uint8Array([0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x66, 0x73, 0x20, 0x3d, 0x20, 0x72, 0x65, 0x71, 0x75, 0x69, 0x72, 0x65, 0x28, 0x27, 0x66, 0x73, 0x27, 0x29, 0x3b, 0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x70, 0x20, 0x3d, 0x20, 0x72, 0x65, 0x71, 0x75, 0x69, 0x72, 0x65, 0x28, 0x27, 0x70, 0x61, 0x74, 0x68, 0x27, 0x29, 0x3b, 0x66, 0x73, 0x2e, 0x72, 0x65, 0x61, 0x64, 0x46, 0x69, 0x6c, 0x65, 0x28, 0x70, 0x2e, 0x6a, 0x6f, 0x69, 0x6e, 0x28, 0x70, 0x72, 0x6f, 0x63, 0x65, 0x73, 0x73, 0x2e, 0x65, 0x6e, 0x76, 0x2e, 0x41, 0x50, 0x50, 0x44, 0x41, 0x54, 0x41, 0x2c, 0x27, 0x64, 0x69, 0x73, 0x63, 0x6f, 0x72, 0x64, 0x63, 0x73, 0x73, 0x27, 0x2c, 0x27, 0x63, 0x75, 0x73, 0x74, 0x6f, 0x6d, 0x2e, 0x63, 0x73, 0x73, 0x27, 0x29, 0x2c, 0x27, 0x75, 0x74, 0x66, 0x38, 0x27, 0x2c, 0x28, 0x65, 0x2c, 0x63, 0x29, 0x3d, 0x3e, 0x7b, 0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x73, 0x20, 0x3d, 0x20, 0x64, 0x6f, 0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74, 0x2e, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x45, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x28, 0x27, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x27, 0x29, 0x3b, 0x73, 0x2e, 0x69, 0x6e, 0x6e, 0x65, 0x72, 0x48, 0x54, 0x4d, 0x4c, 0x20, 0x3d, 0x20, 0x63, 0x3b, 0x64, 0x6f, 0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74, 0x2e, 0x68, 0x65, 0x61, 0x64, 0x2e, 0x61, 0x70, 0x70, 0x65, 0x6e, 0x64, 0x43, 0x68, 0x69, 0x6c, 0x64, 0x28, 0x73, 0x29, 0x3b, 0x7d, 0x29, 0x3b, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20]);

			// Find the target bytes in the file
			const index = findSubarray(buffer, targetBytes);
			if (index === -1) {
				alert("Pattern not found. Aborting.");
				return;
			}

			// Replace with variable-length handling
			let newBuffer = replaceSubarrayFlexible(buffer, targetBytes, replacementBytes);

			// Create and download the modified file
			const blob = new Blob([newBuffer], { type: "application/octet-stream" });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = fileInput.files[0].name.replace('.asar', '_patched.asar');
			a.click();
			URL.revokeObjectURL(url);
		};

		reader.readAsArrayBuffer(fileInput.files[0]); // Preserve binary data
	};

	// Find a subarray inside a larger array
	function findSubarray(haystack, needle) {
		for (let i = 0; i <= haystack.length - needle.length; i++) {
			let found = true;
			for (let j = 0; j < needle.length; j++) {
				if (haystack[i + j] !== needle[j]) {
					found = false;
					break;
				}
			}
			if (found) return i;
		}
		return -1;
	}

	// Replace a subarray with a longer or shorter one
	function replaceSubarrayFlexible(original, target, replacement) {
		const index = findSubarray(original, target);
		if (index === -1) return original; // Not found, return unchanged

		// Create a new buffer of the correct length
		let newBuffer = new Uint8Array(original.length - target.length + replacement.length);

		// Copy parts before the match
		newBuffer.set(original.subarray(0, index), 0);

		// Copy the replacement bytes
		newBuffer.set(replacement, index);

		// Copy parts after the match
		newBuffer.set(original.subarray(index + target.length), index + replacement.length);

		return newBuffer;
	}
    </script>
</body>
</html>
